<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>English Speaking Practice App</title>
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&display=swap" rel="stylesheet">
  <!-- PWA setup -->
  <link rel="manifest" href="https://raw.githubusercontent.com/contactluva/bird70/main/manifest.json" />
  <meta name="theme-color" content="#cc33aa" />
  <link rel="icon" href="https://raw.githubusercontent.com/contactluva/bird70/main/dau2.png" type="image/png" />
  <!-- Th√™m Puter.js -->
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body {
      font-family: 'Bubblegum Sans', cursive;
      font-size: 18px;
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      background: #ffeefc;
      border-radius: 20px;
      box-shadow: 0 0 12px rgba(255, 192, 203, 0.5);
      color: #5a005a;
    }
    input, button {
      padding: 12px;
      font-size: 18px;
      margin: 6px 0;
      box-sizing: border-box;
      font-family: inherit;
    }
    input[type="text"] {
      width: 100%;
      border: 2px solid #f7c5ff;
      border-radius: 10px;
    }
    button {
      background: #1491a5;
      color: white;
      border: none;
      border-radius: 12px;
      transition: 0.2s;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-right: 12px;
      margin-bottom: 10px;
      padding: 12px 24px;
    }
    button:hover {
      transform: scale(1.05);
    }
    h2, h3 { color: #cc33aa; }
    .section { margin-bottom: 30px; }
    .hidden { display: none; }
    .sticky-header {
      position: sticky;
      top: 0;
      background: #fff0f9;
      padding: 12px 20px;
      border-bottom: 3px dashed #ffb4f2;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .sticky-header img {
      width: 40px;
      height: 40px;
    }
    .sticky-header .content {
      font-size: 28px;
      font-weight: bold;
      color: #000;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 5px;
    }
    .sticky-header .content span {
      margin: 0 6px;
    }
    .bar {
      height: 22px;
      background: #ffd6f5;
      margin-top: 10px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #f9c2e6;
    }
    .bar-fill {
      height: 100%;
      width: 0%;
      background: #ff66cc;
      text-align: center;
      color: white;
      font-weight: bold;
      transition: width 0.5s;
    }
    .letter-box {
      display: inline-block;
      width: 36px;
      height: 44px;
      border: 2px dashed #eeaadd;
      margin: 2px;
      text-align: center;
      font-size: 20px;
      background: #fff8fc;
      border-radius: 6px;
    }
    .word-group {
      margin-right: 18px;
      display: inline-block;
    }
    @media (max-width: 600px) {
      body {
        padding: 15px;
        margin: 10px;
        font-size: 16px;
      }
      .sticky-header {
        align-items: flex-start;
      }
      .sticky-header img {
        width: 36px;
        height: 36px;
      }
      .sticky-header .content {
        font-size: 18px;
      }
      button {
        width: 100%;
        margin-right: 0;
        margin-bottom: 12px;
        padding: 14px;
        font-size: 17px;
      }
      input[type="text"] {
        font-size: 16px;
      }
      .letter-box {
        width: 30px;
        height: 40px;
        font-size: 18px;
      }
      .section h3 {
        font-size: 18px;
      }
      h2 {
        font-size: 22px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div id="inputSection">
    <h2>üå∏ Dau Dau English Practiceüå∏</h2>
    <div class="section">
      <input id="sentenceInput" type="text" placeholder="Nh·∫≠p 1 c√¢u ti·∫øng Anh c·∫ßn h·ªçc" />
      <input id="keyword1Input" type="text" placeholder="T·ª´ m·ªõi 1" />
      <input id="keyword2Input" type="text" placeholder="T·ª´ m·ªõi 2" />
      <button onclick="startPractice()">‚ú® Start ‚ú®</button>
    </div>
  </div>

  <div id="stickyHeader" class="sticky-header hidden">
    <img src="https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/dau.png" alt="Icon" />
    <div>
      <div style="font-size: 14px; color: #888;">Sentence ‚Ä¢ Keywords</div>
      <div class="content">
        <span id="stickySentence"></span>
        <span>|</span>
        <span id="stickyKeyword1"></span>
        <span>‚Ä¢</span>
        <span id="stickyKeyword2"></span>
      </div>
    </div>
  </div>

  <div id="practiceContent" class="hidden">
    <div class="section">
      <h3>1. üîä Read the Sentence</h3>
      <button onclick="speak(false, this)">Read Normally</button>
      <button onclick="speak(true, this)">Read Slowly</button>
    </div>

    <div class="section">
      <h3>2. üßÅ Read Keywords</h3>
      <button onclick="speakKeyword(1, this)">Keyword 1</button>
      <button onclick="speakKeyword(2, this)">Keyword 2</button>
    </div>

    <div class="section">
      <h3>3. üé§ Speak and Get Score</h3>
      <button onclick="startRecognition()">Start Recording</button>
      <p id="userSpeech">You said: ...</p>
      <div class="bar"><div id="scoreBar" class="bar-fill">0/10</div></div>
    </div>

    <div class="section">
      <h3>3.5 üéß Check Your Keywords</h3>
      <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        <div style="flex: 1 1 48%;">
          <button onclick="checkKeyword(1)">üéôÔ∏è Record Keyword 1</button>
          <p id="keyword1Result">Keyword 1: ...</p>
          <div class="bar"><div id="keyword1Bar" class="bar-fill">0/1</div></div>
        </div>
        <div style="flex: 1 1 48%;">
          <button onclick="checkKeyword(2)">üéôÔ∏è Record Keyword 2</button>
          <p id="keyword2Result">Keyword 2: ...</p>
          <div class="bar"><div id="keyword2Bar" class="bar-fill">0/1</div></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>4. ‚úçÔ∏è Rewrite the Sentence</h3>
      <div id="rewriteBoxes"></div>
      <br>
      <button onclick="checkRewrite()">Check</button>
      <div class="bar"><div id="rewriteBar" class="bar-fill">0/10</div></div>
    </div>
  </div>

  <script>
    let sentence = '', keyword1 = '', keyword2 = '';

    function startPractice() {
      sentence = document.getElementById("sentenceInput").value.trim();
      keyword1 = document.getElementById("keyword1Input").value.trim();
      keyword2 = document.getElementById("keyword2Input").value.trim();
      if (!sentence || !keyword1 || !keyword2) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng!");

      document.getElementById("inputSection").classList.add("hidden");
      document.getElementById("practiceContent").classList.remove("hidden");
      document.getElementById("stickyHeader").classList.remove("hidden");

      document.getElementById("stickySentence").textContent = sentence;
      document.getElementById("stickyKeyword1").textContent = keyword1;
      document.getElementById("stickyKeyword2").textContent = keyword2;

      createRewriteBoxes();
    }

    function disableButton(btn, label = "...") {
      btn.disabled = true;
      btn.dataset.originalText = btn.textContent;
      btn.textContent = label;
    }

    function enableButton(btn) {
      btn.disabled = false;
      btn.textContent = btn.dataset.originalText;
    }

    function speak(slow, btn) {
      disableButton(btn);
      if (!slow) {
        // ƒê·ªçc b√¨nh th∆∞·ªùng
        const text = sentence;
        const options = {
          voice: "Joanna", // Gi·ªçng n·ªØ M·ªπ
          engine: "neural",
          language: "en-US",
          rate: 1.0
        };
        puter.ai.txt2speech(text, options)
          .then((audio) => {
            audio.play();
            enableButton(btn);
          })
          .catch((error) => {
            console.error('L·ªói ph√°t √¢m:', error);
            alert('L·ªói ph√°t √¢m: Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i.');
            enableButton(btn);
          });
      } else {
        // ƒê·ªçc ch·∫≠m: Chia c√¢u th√†nh t·ª´ng t·ª´ v√† ph√°t t·ª´ng t·ª´
        const words = sentence.split(" ");
        let index = 0;
        function speakNext() {
          if (index >= words.length) {
            enableButton(btn);
            return;
          }
          const text = words[index];
          const options = {
            voice: "Joanna",
            engine: "neural",
            language: "en-US",
            rate: 0.6 // T·ªëc ƒë·ªô ch·∫≠m cho m·ªói t·ª´
          };
          puter.ai.txt2speech(text, options)
            .then((audio) => {
              audio.play();
              audio.onended = () => {
                index++;
                setTimeout(speakNext, 500); // Kho·∫£ng d·ª´ng 500ms gi·ªØa c√°c t·ª´
              };
            })
            .catch((error) => {
              console.error('L·ªói ph√°t √¢m:', error);
              alert('L·ªói ph√°t √¢m: Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i.');
              enableButton(btn);
            });
        }
        speakNext();
      }
    }

    function speakKeyword(n, btn) {
      disableButton(btn);
      const text = n === 1 ? keyword1 : keyword2;
      const options = {
        voice: "Joanna",
        engine: "neural",
        language: "en-US",
        rate: 1.0
      };
      puter.ai.txt2speech(text, options)
        .then((audio) => {
          audio.play();
          enableButton(btn);
        })
        .catch((error) => {
          console.error('L·ªói ph√°t √¢m:', error);
          alert('L·ªói ph√°t √¢m: Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i.');
          enableButton(btn);
        });
    }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';

    function startRecognition() {
      recognition.start();
      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById("userSpeech").textContent = "You said: " + transcript;
        evaluatePronunciation(transcript);
      };
      recognition.onerror = function (event) {
        alert("L·ªói ghi √¢m: " + event.error);
      };
    }

    function checkKeyword(n) {
      recognition.start();
      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript.toLowerCase();
        const keyword = n === 1 ? keyword1.toLowerCase() : keyword2.toLowerCase();
        const resultId = n === 1 ? "keyword1Result" : "keyword2Result";
        const barId = n === 1 ? "keyword1Bar" : "keyword2Bar";
        document.getElementById(resultId).textContent = `You said: ${transcript}`;
        const score = transcript.includes(keyword) ? 1 : 0;
        updateBar(barId, score, 1);
      };
    }

    function levenshteinDistance(a, b) {
      const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
      for (let i = 0; i <= a.length; i++) dp[i][0] = i;
      for (let j = 0; j <= b.length; j++) dp[0][j] = j;
      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }
      return dp[a.length][b.length];
    }

    function evaluatePronunciation(userSpeech) {
      const dist = levenshteinDistance(userSpeech.toLowerCase(), sentence.toLowerCase());
      const score = Math.max(0, 10 - dist);
      updateBar("scoreBar", score, 10);
    }

    function createRewriteBoxes() {
      const container = document.getElementById("rewriteBoxes");
      container.innerHTML = "";
      const words = sentence.split(" ");
      words.forEach(word => {
        const group = document.createElement("div");
        group.className = "word-group";
        [...word].forEach(() => {
          const input = document.createElement("input");
          input.className = "letter-box";
          input.maxLength = 1;
          group.appendChild(input);
        });
        container.appendChild(group);
      });
    }

    function checkRewrite() {
      const boxes = document.querySelectorAll(".letter-box");
      const typed = Array.from(boxes).map(b => b.value).join("");
      const original = sentence.replace(/\s/g, "");
      const dist = levenshteinDistance(typed.toLowerCase(), original.toLowerCase());
      const score = Math.max(0, 10 - dist);
      updateBar("rewriteBar", score, 10);
    }

    function updateBar(id, score, max) {
      const bar = document.getElementById(id);
      bar.style.width = (score / max * 100) + "%";
      bar.textContent = `${score}/${max}`;
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(reg => {
          console.log('‚úÖ Service Worker registered!', reg);
        }).catch(err => {
          console.error('‚ùå Service Worker registration failed:', err);
        });
      });
    }
  </script>
</body>
</html>
