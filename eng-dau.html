<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>English Speaking Practice App</title>
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&display=swap" rel="stylesheet" />
  <meta name="theme-color" content="#cc33aa" />
  <link rel="icon" href="https://raw.githubusercontent.com/contactluva/bird70/main/dau2.png" type="image/png" />
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body {
      font-family: 'Bubblegum Sans', cursive;
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      background: #ffeefc;
      border-radius: 20px;
      color: #5a005a;
    }
    input, button {
      font-family: inherit;
      font-size: 18px;
      padding: 12px;
      margin: 6px 0;
      border-radius: 10px;
    }
    button {
      background: #1491a5;
      color: white;
      border: none;
      font-weight: bold;
      transition: 0.2s;
    }
    button:hover {
      transform: scale(1.05);
    }
    .bar {
      height: 22px;
      background: #ffd6f5;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #f9c2e6;
    }
    .bar-fill {
      height: 100%;
      width: 0%;
      background: #ff66cc;
      text-align: center;
      color: white;
      font-weight: bold;
      transition: width 0.5s;
    }
  </style>
</head>
<body>
  <h2>🌸 Dau Dau English Practice🌸</h2>
  <div>
    <input id="sentenceInput" type="text" placeholder="Nhập câu tiếng Anh cần học"/>
    <button onclick="startPractice()">✨ Start ✨</button>
  </div>

  <div id="practiceSection" style="display:none;">
    <p><strong>Câu luyện nói:</strong> <span id="sentenceText"></span></p>

    <h3>1. 🔊 Phát âm câu</h3>
    <button onclick="speak(false)">Đọc bình thường</button>
    <button onclick="speak(true)">Đọc chậm</button>

    <h3>2. 🎤 Ghi âm và chấm điểm</h3>
    <button id="startBtn" onclick="startRecording()">Start Recording</button>
    <button id="stopBtn" onclick="stopRecording()" disabled>Stop Recording</button>
    <p id="userSpeech">Bạn đã nói: ...</p>
    <div class="bar"><div id="scoreBar" class="bar-fill">0/10</div></div>
  </div>

  <script>
    let sentence = "";
    let mediaRecorder;
    let chunks = [];

    function startPractice() {
      sentence = document.getElementById("sentenceInput").value.trim();
      if (!sentence) return alert("Hãy nhập một câu!");
      document.getElementById("sentenceText").textContent = sentence;
      document.getElementById("practiceSection").style.display = "block";
    }

    function speak(slow) {
      const text = sentence;
      const options = {
        voice: "Joanna",
        engine: "neural",
        language: "en-US",
        rate: slow ? 0.6 : 1.0
      };

      if (!slow) {
        puter.ai.txt2speech(text, options).then(audio => audio.play());
      } else {
        const words = text.split(" ");
        let i = 0;
        function next() {
          if (i >= words.length) return;
          puter.ai.txt2speech(words[i++], options).then(audio => {
            audio.play();
            audio.onended = () => setTimeout(next, 500);
          });
        }
        next();
      }
    }

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];

      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = handleRecordingStop;

      mediaRecorder.start();
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("startBtn").disabled = false;
      }
    }

    async function handleRecordingStop() {
      const blob = new Blob(chunks, { type: "audio/webm" });
      const arrayBuffer = await blob.arrayBuffer();

      const res = await fetch('/api/transcribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/octet-stream' },
        body: arrayBuffer
      });

      const data = await res.json();
      const transcript = data.text || "";

      document.getElementById("userSpeech").textContent = "Bạn đã nói: " + transcript;
      evaluatePronunciation(transcript);
    }

    function levenshteinDistance(a, b) {
      const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
      for (let i = 0; i <= a.length; i++) dp[i][0] = i;
      for (let j = 0; j <= b.length; j++) dp[0][j] = j;
      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }
      return dp[a.length][b.length];
    }

    function evaluatePronunciation(userSpeech) {
      const dist = levenshteinDistance(userSpeech.toLowerCase(), sentence.toLowerCase());
      const score = Math.max(0, 10 - dist);
      updateBar("scoreBar", score, 10);
    }

    function updateBar(id, score, max) {
      const bar = document.getElementById(id);
      bar.style.width = (score / max * 100) + "%";
      bar.textContent = `${score}/${max}`;
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('✅ SW registered!', reg))
          .catch(err => console.error('❌ SW failed:', err));
      });
    }
  </script>
</body>
</html>
