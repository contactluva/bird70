<!DOCTYPE html>
<html lang="vi">
<head>
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/prs.jpg">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C√¥ng Ch√∫a H·ªçc Ti·∫øng Anh</title>
    <style>
        /* --- C·∫§U H√åNH CHUNG --- */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background-color: #ffe6f2;
            overflow: hidden;
            touch-action: none;
        }

        #app {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100vw;
            height: 100vh;
        }

        img#popup-gift {
            margin: auto !important;
            scale: 1.2;
            padding-bottom: 20px !important;
        }

        /* --- M√ÄN H√åNH B·∫ÆT ƒê·∫¶U --- */
        #start-screen {
            position: fixed;
            top: 0; left: 0;
            width: 90%; height: 90%;
            background-image: url('https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/daudau.jpg');
            background-size: cover;
            background-position: top right; /* gi·ªØ g√≥c tr√™n ph·∫£i */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #start-main-btn {
            background: rgba(255, 51, 133, 0.95);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 28px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 0 rgba(204, 0, 82, 0.9);
            transition: transform 0.1s, box-shadow 0.1s, opacity 0.1s;
        }
        #start-main-btn:active {
            box-shadow: 0 3px 0 rgba(204, 0, 82, 0.9);
            transform: translateY(3px);
        }

        /* overlay v√¥ h√¨nh ƒë·ªÉ click nghe intro */
        #start-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 3100;
            background: transparent;
            cursor: pointer;
        }

        /* --- PH·∫¶N NH·∫¨P D·ªÆ LI·ªÜU (·∫®N LU√îN) --- */
        #input-section {
            display: none;
            background: #ffb3d9;
            padding: 10px;
            margin-top: 120px;
            width: 100%;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .input-row { margin-bottom: 5px; }
        input {
            padding: 8px;
            border-radius: 15px;
            border: 2px solid #ff66b3;
            width: 250px;
            font-size: 16px;
        }
        button.start-btn {
            background-color: #ff3385;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px #cc0052;
        }
        button.start-btn:active {
            box-shadow: 0 2px #cc0052;
            transform: translateY(2px);
        }

        /* --- THANH TR·∫†NG TH√ÅI (LU√îN ·∫®N) --- */
        #info-bar {
            display: none !important;
        }

        /* --- KHUNG GAME --- */
        #game-container {
            position: relative;
            flex-grow: 1;
            width: 100%;
            max-width: 1000px;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            overflow: hidden;
            border-left: 2px solid #fff;
            border-right: 2px solid #fff;
        }

        /* --- B·∫¢NG ƒêI·ªÇM --- */
        #score-board {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            border: 2px solid #ff66b3;
            font-size: 16px;
            color: #cc0066;
            z-index: 150;
        }

        /* --- N√öT NGHE C√ÇU (V√íNG 1) --- */
        #listen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 10px;
            border-radius: 50%;
            border: 2px solid #ff66b3;
            background: rgba(255, 255, 255, 0.95);
            font-size: 20px;
            cursor: pointer;
            z-index: 151;
            display: none; /* ch·ªâ hi·ªán ·ªü v√≤ng 1 */
        }

        /* --- CANVAS V√íNG 1 --- */
        canvas {
            display: block;
        }

        /* --- UI V√íNG 2 & 3 --- */
        .sort-stage {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background: #fff5f8;
        }

        .stage-title {
            font-size: 24px;
            color: #d63384;
            margin-bottom: 10px;
            text-align: center;
        }

        .sound-btn {
            background: #66c2ff;
            color: #fff;
            border: none;
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .sentence-box {
            min-height: 50px;
            width: 80%;
            background: white;
            border: 3px dashed #ff99cc;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin-bottom: 30px;
            font-size: 22px;
            color: #333;
            gap: 10px;
        }

        .word-pool {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 90%;
        }

        .word-btn {
            background: #ffcce6;
            border: 2px solid #ff66b3;
            color: #cc0066;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s;
        }

        .word-btn:active { transform: scale(0.95); }

        .word-btn.used {
            opacity: 0.3;
            pointer-events: none;
            background: #ccc;
            border-color: #aaa;
        }

        .reset-stage-btn {
            margin-top: 20px;
            background: #ffad33;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            display: none;
        }

        /* --- POPUP TH√îNG B√ÅO + QU√Ä --- */
        #popup {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .popup-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 5px solid #ff66b3;
            text-align: center;
            animation: popIn 0.3s ease-out;
            max-width: 80%;
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .popup-msg {
            font-size: 24px;
            color: #cc0066;
            margin-bottom: 15px;
        }

        #popup-gift {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 15px;
            display: none;
            animation: giftSpinZoom 0.8s ease-out forwards, giftPulse 1.2s 0.8s infinite alternate;
        }

        @keyframes giftSpinZoom {
            from {
                transform: scale(0.3) rotate(0deg);
                filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
            }
            to {
                transform: scale(1.3) rotate(360deg);
                filter: drop-shadow(0 0 20px rgba(255,255,255,1));
            }
        }

        @keyframes giftPulse {
            from { transform: scale(1.1) rotate(360deg); }
            to { transform: scale(1.25) rotate(340deg); }
        }

        .popup-btn {
            background: #ff3385;
            color: white;
            font-size: 20px;
            padding: 10px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
        }

        /* --- MOBILE CONTROLS (V√≤ng 1) --- */
        #mobile-controls {
            position: absolute;
            bottom: 40px;
            width: 100%;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
        }

        .control-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #fff;
            border-radius: 50%;
            pointer-events: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            user-select: none;
            color: #ff3385;
            font-weight: bold;
        }
        
        .control-btn:active {
            background: rgba(255, 102, 179, 0.6);
            color: white;
        }

        .left-controls { display: flex; gap: 15px; }

        /* --- BANNER C√ÇU M·∫™U --- */
        #sentence-banner {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #ff66b3;
            font-size: 32px;
            color: #cc0066;
            font-weight: bold;
            display: none;
            z-index: 50;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 102, 179, 0.5);
        }

        /* --- HI·ªÜU ·ª®NG BOM --- */
        #bomb-effect {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            opacity: 0;
            pointer-events: none;
            z-index: 300;
            transition: opacity 0.2s ease;
        }

        @keyframes shakeScreen {
            0% { transform: translate(0, 0); }
            20% { transform: translate(-15px, 5px); }
            40% { transform: translate(15px, -5px); }
            60% { transform: translate(-10px, 5px); }
            80% { transform: translate(10px, -5px); }
            100% { transform: translate(0, 0); }
        }

        #game-container.shake { animation: shakeScreen 0.5s linear; }

        /* --- PH√ÅO HOA --- */
        .firework {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff, transparent);
            pointer-events: none;
            z-index: 1000;
            animation: fireworkBlast 800ms ease-out forwards;
        }

        @keyframes fireworkBlast {
            from { opacity: 1; transform: translate(0, 0) scale(1); }
            to { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0); }
        }

        /* --- M√ÄN H√åNH CU·ªêI GAME --- */
        #final-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, #ffe6f2, #ffd1ec);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 2000;
        }

        .final-content {
            width: 100%;
            max-width: 600px;
            text-align: center;
            padding-bottom: 60px;
            margin: 0 auto;
        }

        #final-gifts-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .final-gift {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
            animation: giftPulse 1.2s infinite alternate;
        }

        #final-princess {
            width: 100%;
            height: auto;
            object-fit: contain;
            margin-bottom: 20px;
        }

        #final-collect-btn { margin-top: 5px; }

        /* Responsive */
        @media (max-width: 600px) {
            #mobile-controls {
                margin-bottom: 70px;
                display: flex !important;
            }
            .stage-title { font-size: 20px; }
            .word-btn { font-size: 16px; padding: 8px 12px; }
            #sentence-banner { font-size: 24px; width: 80%; }
        }
    </style>
</head>
<body>

    <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu -->
    <div id="start-screen">
        <button id="start-main-btn">B·∫ÆT ƒê·∫¶U</button>
        <!-- overlay v√¥ h√¨nh ƒë·ªÉ click ph√°t intro -->
        <div id="start-overlay"></div>
    </div>

    <div id="app">
        <!-- Input Section (·∫©n, gi·ªØ l·∫°i fallback) -->
        <div id="input-section">
            <div class="input-row">
                <input type="text" id="inp-eng" placeholder="C√¢u Ti·∫øng Anh (VD: I am happy)">
            </div>
            <div class="input-row">
                <input type="text" id="inp-vie" placeholder="Nghƒ©a Ti·∫øng Vi·ªát (VD: T√¥i r·∫•t vui)">
            </div>
            <button class="start-btn" onclick="startGame()">B·∫Øt ƒë·∫ßu ch∆°i!</button>
        </div>

        <!-- Info Bar (lu√¥n ·∫©n) -->
        <div id="info-bar">
            <div>üá¨üáß <span id="info-eng">...</span></div>
            <div>üáªüá≥ <span id="info-vie">...</span></div>
        </div>

        <!-- Game Container -->
        <div id="game-container">
            <!-- B·∫£ng ƒëi·ªÉm -->
            <div id="score-board">ƒêi·ªÉm: <span id="score-value">0</span></div>

            <!-- N√∫t nghe l·∫°i c√¢u (ch·ªâ v√≤ng 1) -->
            <button id="listen-btn">üîä</button>

            <!-- V√≤ng 1: Canvas -->
            <canvas id="gameCanvas"></canvas>
            
            <div id="sentence-banner"></div>

            <!-- Hi·ªáu ·ª©ng bom -->
            <div id="bomb-effect"></div>

            <div id="mobile-controls">
                <div class="left-controls">
                    <div class="control-btn" id="btn-left">‚¨ÖÔ∏è</div>
                    <div class="control-btn" id="btn-right">‚û°Ô∏è</div>
                </div>
                <div class="control-btn" id="btn-jump">‚¨ÜÔ∏è</div>
            </div>

            <!-- V√≤ng 2 UI -->
            <div id="stage2" class="sort-stage">
                <h2 class="stage-title">V√≤ng 2: S·∫Øp x·∫øp c√¢u Ti·∫øng Anh</h2>
                <button class="sound-btn" id="s2-sound-btn">üîä Nghe l·∫°i c√¢u</button>
                <div class="sentence-box" id="s2-box"></div>
                <div class="word-pool" id="s2-pool"></div>
                <button class="reset-stage-btn" id="s2-retry" onclick="setupStage2()">Th·ª≠ l·∫°i</button>
            </div>

            <!-- V√≤ng 3 UI -->
            <div id="stage3" class="sort-stage">
                <h2 class="stage-title">V√≤ng 3: S·∫Øp x·∫øp c√¢u Ti·∫øng Vi·ªát</h2>
                <div class="sentence-box" id="s3-box"></div>
                <div class="word-pool" id="s3-pool"></div>
                <button class="reset-stage-btn" id="s3-retry" onclick="setupStage3()">Th·ª≠ l·∫°i</button>
            </div>
        </div>
    </div>

    <!-- Popup -->
    <div id="popup">
        <div class="popup-content">
            <div class="popup-msg" id="popup-msg"></div>
            <img id="popup-gift" src="" alt="gift">
            <button class="popup-btn" id="popup-btn">NH·∫¨N QU√Ä</button>
        </div>
    </div>

    <!-- M√†n h√¨nh cu·ªëi c√πng sau khi ho√†n th√†nh 3 v√≤ng -->
    <div id="final-screen">
        <div class="final-content">
            <div id="final-gifts-row"></div>
            <img id="final-princess" src="https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/prs.jpg" alt="princess">
            <button id="final-collect-btn" class="popup-btn">Thu th·∫≠p t·∫•t c·∫£</button>
        </div>
    </div>

<script>
    /**
     * D·ªÆ LI·ªÜU GAME
     */
    const gameState = {
        engSentence: "",
        vieSentence: "",
        engWords: [],
        vieWords: [],
        distractorWords: ["very", "bad", "sky", "dog", "cat", "run", "no", "yes", "big"],
        currentStage: 0,
        collectedIndices: [],
    };

    // DOM Elements
    const inputSection = document.getElementById('input-section');
    const gameContainer = document.getElementById('game-container');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const sentenceBanner = document.getElementById('sentence-banner');
    const popup = document.getElementById('popup');
    const popupMsg = document.getElementById('popup-msg');
    const popupBtn = document.getElementById('popup-btn');
    const popupGift = document.getElementById('popup-gift');
    const bombOverlay = document.getElementById('bomb-effect');

    const startScreen = document.getElementById('start-screen');
    const startMainBtn = document.getElementById('start-main-btn');
    const startOverlay = document.getElementById('start-overlay');

    // N√∫t nghe c√¢u v√≤ng 1
    const listenBtn = document.getElementById('listen-btn');

    // M√†n h√¨nh cu·ªëi game
    const finalScreen = document.getElementById('final-screen');
    const finalGiftsRow = document.getElementById('final-gifts-row');
    const finalCollectBtn = document.getElementById('final-collect-btn');

    // B·∫£ng ƒëi·ªÉm
    const scoreEl = document.getElementById('score-value');
    const STORAGE_KEY = 'princess_eng_state_v2';
    const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;

    // Tr·∫°ng th√°i l∆∞u l√¢u d√†i
    let persistentState = {
        score: 0,
        currentSentenceIndex: 0,
        completed: []
    };

    function loadPersistentState() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                updateScoreUI();
                return;
            }
            const data = JSON.parse(raw);
            if (!data || !data.timestamp || (Date.now() - data.timestamp) > THIRTY_DAYS_MS) {
                localStorage.removeItem(STORAGE_KEY);
                updateScoreUI();
                return;
            }
            persistentState.score = data.score || 0;
            persistentState.currentSentenceIndex =
                typeof data.currentSentenceIndex === 'number' ? data.currentSentenceIndex : 0;
            persistentState.completed = Array.isArray(data.completed) ? data.completed : [];
        } catch (e) {
            console.error(e);
        }
        updateScoreUI();
    }

    function savePersistentState() {
        try {
            const data = {
                score: persistentState.score || 0,
                currentSentenceIndex: typeof persistentState.currentSentenceIndex === 'number'
                    ? persistentState.currentSentenceIndex : 0,
                completed: Array.isArray(persistentState.completed) ? persistentState.completed : [],
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
            console.error(e);
        }
    }

    function updateScoreUI() {
        if (scoreEl) {
            scoreEl.textContent = persistentState.score || 0;
        }
    }

    function addScore(points) {
        persistentState.score = (persistentState.score || 0) + points;
        updateScoreUI();
        savePersistentState();
    }

    loadPersistentState();

    // Danh s√°ch URL qu√† sticker
    const giftImages = [
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-1.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-2.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-3.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-4.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-5.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-6.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-7.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-8.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-9.png",
        "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/a-10.png"
    ];

    // L∆∞u 3 m√≥n qu√† ƒë√£ nh·∫≠n ·ªü 3 v√≤ng
    const earnedGifts = [null, null, null];

    // √Çm thanh qu√† t·∫∑ng
    const rewardSounds = [
        new Audio("https://github.com/contactluva/bird70/raw/refs/heads/main/daukhen.mp3"),
        new Audio("https://github.com/contactluva/bird70/raw/refs/heads/main/daukhen2.mp3")
    ];
    let usedRewardSoundIndices = [];

    function playRandomRewardSound() {
        if (!rewardSounds.length) return;

        const allIndices = rewardSounds.map((_, i) => i);
        let available = allIndices.filter(i => !usedRewardSoundIndices.includes(i));

        if (available.length === 0) {
            usedRewardSoundIndices = [];
            available = allIndices.slice();
        }

        const chosenIndex = available[Math.floor(Math.random() * available.length)];
        usedRewardSoundIndices.push(chosenIndex);

        const sound = rewardSounds[chosenIndex];
        try {
            sound.currentTime = 0;
            sound.play().catch(() => {});
        } catch(e) {}
    }

    // √Çm thanh intro (click overlay)
    const introVoice = new Audio("https://github.com/contactluva/bird70/raw/refs/heads/main/dauvoice.mp3");

    // √Çm thanh nh·∫£y (volume 0.3)
    const jumpSound = new Audio("https://github.com/contactluva/bird70/raw/refs/heads/main/jump.mp3");
    jumpSound.volume = 0.3;

    // √Çm thanh bom n·ªï
    const boomSound = new Audio("https://github.com/contactluva/bird70/raw/refs/heads/main/boom.mp3");
    boomSound.volume = 1;

    // ·∫¢nh c√¥ng ch√∫a
    const princessImg = new Image();
    princessImg.crossOrigin = "anonymous";
    princessImg.src = "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/pmr.png";
    let princessLoaded = false;
    princessImg.onload = () => { princessLoaded = true; };

    /* ----------------- QU·∫¢N L√ù GI·ªåNG N√ìI (EN) ----------------- */
    let allVoices = [];

    function loadVoices() {
        if (!('speechSynthesis' in window)) return;
        allVoices = window.speechSynthesis.getVoices();
    }
    if ('speechSynthesis' in window) {
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();
    }

    function getVoiceByLangPrefix(prefix) {
        if (!allVoices || !allVoices.length) return null;
        prefix = prefix.toLowerCase();
        return allVoices.find(v => v.lang && v.lang.toLowerCase().startsWith(prefix)) || null;
    }

    // ƒë·ªçc c√¢u ti·∫øng Anh
    function speak(text) {
        if (!('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        const v = getVoiceByLangPrefix('en');
        if (v) u.voice = v;
        window.speechSynthesis.speak(u);
    }

    function speakThen(text, callback) {
        if (!('speechSynthesis' in window)) {
            if (callback) setTimeout(callback, 500);
            return;
        }
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        const v = getVoiceByLangPrefix('en');
        if (v) u.voice = v;
        u.rate = 1;
        u.onend = () => { if (callback) callback(); };
        u.onerror = () => { if (callback) callback(); };
        try {
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        } catch (e) {
            if (callback) callback();
        }
    }

    function speakWord(word) {
        if (!('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(word);
        u.lang = 'en-US';
        const v = getVoiceByLangPrefix('en');
        if (v) u.voice = v;
        u.rate = 1;
        window.speechSynthesis.speak(u);
    }

    /**
     * LOAD DANH S√ÅCH C√ÇU T·ª™ FILE eng.txt
     */
    const SENTENCE_URL = "https://raw.githubusercontent.com/contactluva/bird70/refs/heads/main/eng.txt";
    let sentenceList = [];
    let sentenceListLoaded = false;
    let sentenceListLoading = false;

    function parseSentenceFile(text) {
        const blocks = text.split(/###\s*C√¢u\s+\d+/).map(b => b.trim()).filter(b => b);
        const list = [];
        blocks.forEach(block => {
            const enMatch = block.match(/EN:\s*(.+)/i);
            const viMatch = block.match(/VI:\s*(.+)/i);
            if (enMatch && viMatch) {
                list.push({
                    en: enMatch[1].trim(),
                    vi: viMatch[1].trim()
                });
            }
        });
        return list;
    }

    async function loadSentenceList() {
        if (sentenceListLoaded || sentenceListLoading) return;
        sentenceListLoading = true;
        try {
            const res = await fetch(SENTENCE_URL + "?t=" + Date.now());
            if (!res.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c file c√¢u.");
            const text = await res.text();
            const parsed = parseSentenceFile(text);
            if (parsed.length > 0) {
                sentenceList = parsed;
                sentenceListLoaded = true;
            }
        } catch (e) {
            console.error(e);
        } finally {
            sentenceListLoading = false;
        }
    }

    function getCurrentSentenceFromList() {
        if (!sentenceListLoaded || !sentenceList.length) return null;
        let idx = persistentState.currentSentenceIndex;
        if (typeof idx !== 'number' || idx < 0) idx = 0;
        if (idx >= sentenceList.length) idx = 0;
        persistentState.currentSentenceIndex = idx;
        savePersistentState();
        return sentenceList[idx];
    }

    function markSentenceCompleted() {
        if (!sentenceListLoaded || !sentenceList.length) return;
        let idx = persistentState.currentSentenceIndex;
        if (typeof idx !== 'number' || idx < 0 || idx >= sentenceList.length) return;

        if (!Array.isArray(persistentState.completed)) {
            persistentState.completed = [];
        }
        if (!persistentState.completed.includes(idx)) {
            persistentState.completed.push(idx);
            addScore(1);
        }
        persistentState.currentSentenceIndex = idx + 1;
        savePersistentState();
    }

    /**
     * KH·ªûI T·∫†O GAME
     */
    async function startGame() {
        await loadSentenceList();
        let chosenSentence = null;

        if (sentenceListLoaded && sentenceList.length) {
            chosenSentence = getCurrentSentenceFromList();
        }

        if (chosenSentence) {
            gameState.engSentence = chosenSentence.en;
            gameState.vieSentence = chosenSentence.vi;
        } else {
            const rawEng = document.getElementById('inp-eng')?.value.trim() || "I am happy today";
            const rawVie = document.getElementById('inp-vie')?.value.trim() || "H√¥m nay em r·∫•t vui";
            gameState.engSentence = rawEng;
            gameState.vieSentence = rawVie;
        }

        gameState.engWords = gameState.engSentence.split(/\s+/).map(w => w.replace(/[.,?!]/g, ''));
        gameState.vieWords = gameState.vieSentence.split(/\s+/).map(w => w.replace(/[.,?!]/g, ''));

        if (inputSection) inputSection.style.display = 'none';

        setupStage1();
    }

    /* ------------------------------------------------------------------
       V√íNG 1: MARIO STYLE
       ------------------------------------------------------------------ */
    let animationFrameId;
    const physics = {
        gravity: 0.6,
        friction: 0.8,
        jumpPower: -12,
        speed: 5
    };

    const player = {
        x: 50, y: 0, 
        vx: 0, vy: 0, 
        width: 40, height: 60,
        grounded: false,
        color: '#ff66b3',
        groundY: 0,
        facing: 1
    };

    const camera = { x: 0 };
    let blocks = [];
    let particles = [];
    let showBannerTimeout;

    const keys = { right: false, left: false, up: false };

    function setupStage1() {
        gameState.currentStage = 1;
        gameState.collectedIndices = [];
        document.getElementById('stage2').style.display = 'none';
        document.getElementById('stage3').style.display = 'none';
        canvas.style.display = 'block';

        if (listenBtn) {
            listenBtn.style.display = 'block';
            listenBtn.onclick = () => {
                speak(gameState.engSentence);
            };
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        player.x = 50;
        player.y = player.groundY - player.height;
        player.vx = 0;
        player.vy = 0;
        player.facing = 1;

        createBlocks();

        sentenceBanner.innerText = gameState.engSentence;
        sentenceBanner.style.display = 'block';
        clearTimeout(showBannerTimeout);
        showBannerTimeout = setTimeout(() => {
            sentenceBanner.style.display = 'none';
        }, 5000);

        // ƒê·ªçc c√¢u ti·∫øng Anh khi b·∫Øt ƒë·∫ßu v√≤ng 1
        speak(gameState.engSentence);

        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        gameLoop();
    }

    function resizeCanvas() {
        if (gameState.currentStage === 1) {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
            player.groundY = Math.floor(canvas.height * 0.7);
        }
    }

    function createBlocks() {
        blocks = [];
        const correctWords = gameState.engWords.map((w, i) => ({ text: w, type: 'correct', index: i }));
        const wrongWords = [];
        for(let i=0; i<3; i++) {
            const randWord = gameState.distractorWords[Math.floor(Math.random() * gameState.distractorWords.length)];
            wrongWords.push({ text: randWord, type: 'wrong', index: -1 });
        }

        const allItems = [...correctWords, ...wrongWords];
        allItems.sort(() => Math.random() - 0.5);

        let currentX = 200;
        const blockH = 40;

        allItems.forEach(item => {
            const jumpReach = 150;
            const y = player.groundY - jumpReach - (Math.random() * 60);
            const w = Math.max(80, item.text.length * 12);

            blocks.push({
                x: currentX,
                y: y,
                width: w,
                height: blockH,
                word: item.text,
                type: item.type,
                index: item.index,
                hit: false,
                scale: 1
            });
            currentX += 200;
        });
    }

    function update() {
        if (keys.right) player.vx += 1;
        if (keys.left) player.vx -= 1;
        if (keys.up && player.grounded) {
            player.vy = physics.jumpPower;
            player.grounded = false;
            try {
                jumpSound.currentTime = 0;
                jumpSound.play().catch(()=>{});
            } catch(e){}
        }

        player.vx *= physics.friction;
        player.vy += physics.gravity;

        player.x += player.vx;
        player.y += player.vy;

        if (player.y + player.height > player.groundY) {
            player.y = player.groundY - player.height;
            player.vy = 0;
            player.grounded = true;
        }

        if (player.x < 0) { player.x = 0; player.vx = 0; }

        let targetCamX = player.x - canvas.width / 3;
        if (targetCamX < 0) targetCamX = 0;
        camera.x += (targetCamX - camera.x) * 0.1;

        blocks.forEach(block => {
            if (block.hit) return;

            if (player.x < block.x + block.width &&
                player.x + player.width > block.x &&
                player.y < block.y + block.height &&
                player.y + player.height > block.y) {

                const prevY = player.y - player.vy;
                if (player.vy < 0 && prevY >= block.y + block.height - 10) {
                    player.vy = 0;
                    player.y = block.y + block.height;
                    hitBlock(block);
                }
            }
        });

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].life--;
            particles[i].x += particles[i].vx;
            particles[i].y += particles[i].vy;
            if (particles[i].life <= 0) particles.splice(i, 1);
        }
    }

    function hitBlock(block) {
        block.hit = true;
        block.scale = 1.2;

        // Sau khi nh·∫£y ƒë·∫≠p block, ƒë·ªçc t·ª´ ƒë√≥ tr·ªÖ 300ms
        if (block.word) {
            setTimeout(() => {
                speakWord(block.word);
            }, 300);
        }

        if (block.type === 'correct') {
            createParticles(block.x + block.width/2, block.y + block.height/2, '#00ff00');
            gameState.collectedIndices.push(block.index);
            if (gameState.collectedIndices.length === gameState.engWords.length) {
                setTimeout(() => {
                    showPopup(
                        "Ho√†n th√†nh V√≤ng 1!<br>ƒê·∫≠u ƒë∆∞·ª£c t·∫∑ng m·ªôt m√≥n qu√†!",
                        () => {
                            canvas.style.display = 'none';
                            if (listenBtn) listenBtn.style.display = 'none';
                            setupStage2();
                        },
                        1
                    );
                }, 500);
            }
        } else {
            try {
                boomSound.currentTime = 0;
                boomSound.play().catch(()=>{});
            } catch(e){}

            createParticles(block.x + block.width/2, block.y + block.height/2, '#ff0000');
            bombOverlay.style.opacity = '0.9';
            gameContainer.classList.add('shake');

            setTimeout(() => {
                bombOverlay.style.opacity = '0';
                gameContainer.classList.remove('shake');
                setupStage1();
            }, 700);
        }
    }

    function createParticles(x, y, color) {
        for(let i=0; i<10; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 5,
                vy: (Math.random() - 0.5) * 5,
                life: 30,
                color: color
            });
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-camera.x, 0);

        const groundWidth = 3000;
        ctx.fillStyle = "#8B4513";
        ctx.fillRect(0, player.groundY, groundWidth, canvas.height - player.groundY);
        ctx.fillStyle = "#32CD32";
        ctx.fillRect(0, player.groundY, groundWidth, 10);

        blocks.forEach(block => {
            if (block.hit && block.type === 'wrong') return;
            ctx.globalAlpha = (block.hit && block.type === 'correct') ? 0.5 : 1;

            ctx.fillStyle = "#FFD700";
            ctx.fillRect(block.x, block.y, block.width, block.height);
            ctx.strokeStyle = "#DAA520";
            ctx.lineWidth = 2;
            ctx.strokeRect(block.x, block.y, block.width, block.height);

            ctx.fillStyle = "#000";
            ctx.font = "bold 23px Comic Sans MS";
            ctx.textAlign = "center";
            ctx.fillText(block.word, block.x + block.width/2, block.y + 25);
            ctx.globalAlpha = 1;
        });

        if (princessLoaded) {
            const baseHeight = player.height * 1.5;
            const scale = baseHeight / princessImg.naturalHeight;
            const drawHeight = princessImg.naturalHeight * scale;
            const drawWidth = princessImg.naturalWidth * scale;

            const drawX = player.x + (player.width - drawWidth) / 2;
            const drawY = player.y + (player.height - drawHeight);

            ctx.save();
            if (player.facing === -1) {
                ctx.translate(drawX + drawWidth, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(princessImg, 0, drawY, drawWidth, drawHeight);
            } else {
                ctx.drawImage(princessImg, drawX, drawY, drawWidth, drawHeight);
            }
            ctx.restore();
        } else {
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x + player.width/2, player.y + player.height/2, player.width/2, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = "#000";
            ctx.fillText("üë∏", player.x + player.width/2, player.y + player.height/2 + 5);
        }

        particles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
            ctx.fill();
        });

        ctx.restore();
    }

    function gameLoop() {
        if (gameState.currentStage !== 1) return;
        update();
        draw();
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    // Keyboard
    window.addEventListener('keydown', (e) => {
        if (e.code === 'ArrowRight' || e.code === 'KeyD') {
            keys.right = true;
            player.facing = 1;
        }
        if (e.code === 'ArrowLeft' || e.code === 'KeyA') {
            keys.left = true;
            player.facing = -1;
        }
        if (e.code === 'ArrowUp' || e.code === 'Space') keys.up = true;
    });

    window.addEventListener('keyup', (e) => {
        if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
        if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
        if (e.code === 'ArrowUp' || e.code === 'Space') keys.up = false;
    });

    // Mobile Buttons
    function setupTouchBtn(id, keyProp) {
        const btn = document.getElementById(id);
        btn.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            keys[keyProp] = true; 
            if (keyProp === 'left') player.facing = -1;
            if (keyProp === 'right') player.facing = 1;
        });
        btn.addEventListener('touchend', (e) => { 
            e.preventDefault(); 
            keys[keyProp] = false; 
        });
        btn.addEventListener('mousedown', () => { 
            keys[keyProp] = true; 
            if (keyProp === 'left') player.facing = -1;
            if (keyProp === 'right') player.facing = 1;
        });
        btn.addEventListener('mouseup', () => { 
            keys[keyProp] = false; 
        });
    }
    setupTouchBtn('btn-left', 'left');
    setupTouchBtn('btn-right', 'right');
    setupTouchBtn('btn-jump', 'up');

    /* ------------------------------------------------------------------
       V√íNG 2
       ------------------------------------------------------------------ */
    function getStage2CurrentWords() {
        const box = document.getElementById('s2-box');
        const spans = box.querySelectorAll('span');
        return Array.from(spans).map(s => s.innerText.trim());
    }

    function setupStage2() {
        gameState.currentStage = 2;
        document.getElementById('stage2').style.display = 'flex';
        document.getElementById('stage3').style.display = 'none';

        const box = document.getElementById('s2-box');
        const pool = document.getElementById('s2-pool');
        const retryBtn = document.getElementById('s2-retry');

        box.innerHTML = '';
        pool.innerHTML = '';
        retryBtn.style.display = 'none';

        const soundBtn = document.getElementById('s2-sound-btn');
        soundBtn.onclick = () => {
            speak(gameState.engSentence);
        };

        const shuffled = [...gameState.engWords].sort(() => Math.random() - 0.5);

        shuffled.forEach((word) => {
            const btn = document.createElement('div');
            btn.className = 'word-btn';
            btn.innerText = word;

            btn.onclick = () => {
                if (btn.classList.contains('used')) return;

                speakWord(word);

                const span = document.createElement('span');
                span.innerText = word;
                span.style.cursor = 'pointer';

                span.onclick = () => {
                    box.removeChild(span);
                    btn.classList.remove('used');
                    document.getElementById('s2-retry').style.display = 'none';
                    checkStage2();
                };

                box.appendChild(span);
                btn.classList.add('used');

                checkStage2();
            };

            pool.appendChild(btn);
        });
    }

    function checkStage2() {
        const retryBtn = document.getElementById('s2-retry');
        const currentWords = getStage2CurrentWords();

        if (currentWords.length === gameState.engWords.length) {
            const attempt = currentWords.join('').toLowerCase();
            const target = gameState.engWords.join('').toLowerCase();

            if (attempt === target) {
                speakThen(gameState.engSentence, () => {
                    showPopup(
                        "Ho√†n th√†nh V√≤ng 2!<br>ƒê·∫≠u l·∫°i nh·∫≠n th√™m m·ªôt m√≥n qu√†!",
                        () => { setupStage3(); },
                        2
                    );
                });
            } else {
                retryBtn.style.display = 'block';
            }
        } else {
            retryBtn.style.display = 'none';
        }
    }

    /* ------------------------------------------------------------------
       V√íNG 3
       ------------------------------------------------------------------ */
    let s3CurrentWords = [];

    function setupStage3() {
        gameState.currentStage = 3;
        document.getElementById('stage2').style.display = 'none';
        document.getElementById('stage3').style.display = 'flex';

        const box = document.getElementById('s3-box');
        const pool = document.getElementById('s3-pool');
        const retryBtn = document.getElementById('s3-retry');

        box.innerHTML = ' : ';
        pool.innerHTML = '';
        retryBtn.style.display = 'none';
        s3CurrentWords = [];

        const shuffled = [...gameState.vieWords].sort(() => Math.random() - 0.5);

        shuffled.forEach((word) => {
            const btn = document.createElement('div');
            btn.className = 'word-btn';
            btn.innerText = word;

            btn.onclick = () => {
                if (btn.classList.contains('used')) return;

                const span = document.createElement('span');
                span.innerText = " " + word;
                span.style.cursor = 'pointer';

                span.onclick = () => {
                    box.removeChild(span);
                    btn.classList.remove('used');
                    const idx = s3CurrentWords.lastIndexOf(word);
                    if (idx !== -1) s3CurrentWords.splice(idx, 1);
                    document.getElementById('s3-retry').style.display = 'none';
                    checkStage3();
                };

                box.appendChild(span);
                s3CurrentWords.push(word);
                btn.classList.add('used');
                checkStage3();
            };

            pool.appendChild(btn);
        });
    }

    function checkStage3() {
        if (s3CurrentWords.length === gameState.vieWords.length) {
            const attempt = s3CurrentWords.join('').toLowerCase();
            const target = gameState.vieWords.join('').toLowerCase();

            if (attempt === target) {
                showPopup(
                    "Ch√∫c m·ª´ng! ƒê·∫≠u ƒë√£ ho√†n th√†nh c·∫£ 3 v√≤ng!<br>Th√™m m·ªôt m√≥n qu√† l·∫•p l√°nh n·ªØa!",
                    () => { showFinalScreen(); },
                    3
                );
            } else {
                document.getElementById('s3-retry').style.display = 'block';
            }
        }
    }

    /* ------------------------------------------------------------------
       PH√ÅO HOA
       ------------------------------------------------------------------ */
    function createFireworksBurst() {
        const colors = ['#FFD700', '#FF69B4', '#87CEFA', '#FFFFFF'];

        const shoot = () => {
            for (let center = 0; center < 8; center++) {
                const originX = Math.random() * window.innerWidth;
                const originY = Math.random() * window.innerHeight * 0.8;

                for (let i = 0; i < 24; i++) {
                    const fw = document.createElement('div');
                    fw.className = 'firework';

                    const angle = Math.random() * Math.PI * 2;
                    const distance = 80 + Math.random() * 160;
                    const dx = Math.cos(angle) * distance;
                    const dy = Math.sin(angle) * distance;

                    fw.style.left = originX + 'px';
                    fw.style.top = originY + 'px';
                    fw.style.setProperty('--dx', dx + 'px');
                    fw.style.setProperty('--dy', dy + 'px');
                    fw.style.background = `radial-gradient(circle, ${colors[Math.floor(Math.random()*colors.length)]}, transparent)`;
                    document.body.appendChild(fw);

                    setTimeout(() => fw.remove(), 1200);
                }
            }
        };

        const interval = setInterval(shoot, 150);
        setTimeout(() => clearInterval(interval), 2000);
    }

    /* ------------------------------------------------------------------
       M√ÄN H√åNH CU·ªêI + N√öT THU TH·∫¨P
       ------------------------------------------------------------------ */
    function showFinalScreen() {
        popup.style.display = 'none';
        finalGiftsRow.innerHTML = '';

        for (let i = 0; i < 3; i++) {
            const img = document.createElement('img');
            img.className = 'final-gift';
            const url = earnedGifts[i] || giftImages[Math.floor(Math.random() * giftImages.length)];
            img.src = url;
            finalGiftsRow.appendChild(img);
        }

        finalScreen.style.display = 'flex';
    }

    finalCollectBtn.onclick = () => {
        markSentenceCompleted();
        finalScreen.style.display = 'none';
        location.reload();
    };

    /* ------------------------------------------------------------------
       POPUP
       ------------------------------------------------------------------ */
    function showPopup(htmlMsg, callback, stageIndex) {
        popupMsg.innerHTML = htmlMsg;

        let chosenUrl = null;
        if (giftImages.length > 0) {
            chosenUrl = giftImages[Math.floor(Math.random() * giftImages.length)];
            popupGift.src = chosenUrl;
            popupGift.style.display = 'block';
        } else {
            popupGift.style.display = 'none';
        }

        if (stageIndex != null && chosenUrl) {
            const idx = stageIndex - 1;
            if (idx >= 0 && idx < earnedGifts.length) {
                earnedGifts[idx] = chosenUrl;
            }
        }

        popup.style.display = 'flex';
        playRandomRewardSound();
        createFireworksBurst();

        popupBtn.onclick = null;
        popupBtn.onclick = () => {
            popup.style.display = 'none';
            if (callback) callback();
        };
    }

    /* ------------------------------------------------------------------
       START OVERLAY + N√öT B·∫ÆT ƒê·∫¶U
       ------------------------------------------------------------------ */
    let introPlayed = false;

    function lockStartButton() {
        if (!startMainBtn) return;
        startMainBtn.disabled = true;
        startMainBtn.style.opacity = 0.6;
        startMainBtn.style.pointerEvents = 'none';
    }

    function unlockStartButton() {
        if (!startMainBtn) return;
        startMainBtn.disabled = false;
        startMainBtn.style.opacity = 1;
        startMainBtn.style.pointerEvents = 'auto';
    }

    lockStartButton(); // l√∫c ƒë·∫ßu kh√¥ng b·∫•m ƒë∆∞·ª£c

    if (startOverlay) {
        startOverlay.addEventListener('click', () => {
            if (introPlayed) return; // tr√°nh play nhi·ªÅu l·∫ßn

            introPlayed = true;
            try {
                introVoice.currentTime = 0;
                introVoice.play()
                    .then(() => {
                        // ch·ªâ sau khi nghe xong m·ªõi cho b·∫•m B·∫ÆT ƒê·∫¶U
                        introVoice.onended = () => {
                            unlockStartButton();
                            if (startOverlay) startOverlay.style.display = 'none';
                        };
                    })
                    .catch(() => {
                        // n·∫øu b·ªã ch·∫∑n, v·∫´n cho ch∆°i
                        unlockStartButton();
                        if (startOverlay) startOverlay.style.display = 'none';
                    });
            } catch (e) {
                unlockStartButton();
                if (startOverlay) startOverlay.style.display = 'none';
            }
        });
    }

    if (startMainBtn) {
        startMainBtn.addEventListener('click', () => {
            if (startMainBtn.disabled) return; // ch∆∞a nghe xong intro th√¨ kh√¥ng cho b·∫•m
            if (startScreen) startScreen.style.display = 'none';
            startGame();
        });
    }
</script>
</body>
</html>
